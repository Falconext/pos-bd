generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Plan {
  id                  Int       @id @default(autoincrement())
  nombre              String    @unique
  descripcion         String?
  limiteUsuarios      Int?
  costo               Decimal   @default(0)
  esPrueba            Boolean   @default(false)
  duracionDias        Int       @default(30)
  tipoFacturacion     String    @default("MENSUAL")
  tieneTienda         Boolean   @default(false)
  maxBanners          Int?      @default(3)
  maxImagenesProducto Int?      @default(1)
  tieneBanners        Boolean   @default(false)
  tieneCulqi          Boolean   @default(false)
  tieneDeliveryGPS    Boolean   @default(false)
  tieneGaleria        Boolean   @default(false)
  maxComprobantes     Int?      @default(100)
  tieneTicketera      Boolean   @default(false)
  empresas            Empresa[]
}

model Ubigeo {
  codigo       String    @id
  departamento String
  provincia    String
  distrito     String
  empresas     Empresa[]
}

model Rubro {
  id         Int                 @id @default(autoincrement())
  nombre     String              @unique
  disenos    DisenoRubro?
  empresas   Empresa[]
  plantillas ProductoPlantilla[]
}

model Empresa {
  id                   Int                @id @default(autoincrement())
  ruc                  String             @unique
  razonSocial          String
  direccion            String
  logo                 String?
  fechaActivacion      DateTime
  fechaExpiracion      DateTime
  planId               Int
  estado               EstadoType         @default(ACTIVO)
  departamento         String?
  distrito             String?
  provincia            String?
  ubigeo               String?
  providerToken        String?
  tokenCreatedAt       DateTime?
  tokenUpdatedAt       DateTime?
  empresaUbigeo        String?
  nombreComercial      String?
  rubroId              Int?
  providerId           String?
  tipoEmpresa          TipoEmpresa        @default(FORMAL)
  aceptaEfectivo       Boolean            @default(true)
  colorPrimario        String?            @default("#000000")
  colorSecundario      String?            @default("#ffffff")
  descripcionTienda    String?
  facebookUrl          String?
  horarioAtencion      String?
  instagramUrl         String?
  plinNumero           String?
  plinQrUrl            String?
  slugTienda           String?            @unique
  tiktokUrl            String?
  whatsappTienda       String?
  yapeNumero           String?
  yapeQrUrl            String?
  aceptaEnvio          Boolean            @default(true)
  aceptaRecojo         Boolean            @default(true)
  esAgenteRetencion    Boolean            @default(false)
  costoEnvioFijo       Decimal?           @default(0)
  direccionRecojo      String?
  tiempoPreparacionMin Int?               @default(30)
  disenoOverride       String?
  banners              Banner[]
  categorias           Categoria[]
  clientes             Cliente[]
  compras              Compra[]
  comprobantes         Comprobante[]
  ubicacion            Ubigeo?            @relation(fields: [empresaUbigeo], references: [codigo])
  plan                 Plan               @relation(fields: [planId], references: [id])
  rubro                Rubro?             @relation(fields: [rubroId], references: [id])
  marcas               Marca[]
  movimientosCaja      MovimientoCaja[]
  movimientosKardex    MovimientoKardex[]
  Notificacion         Notificacion[]
  pagos                Pago[]
  pagosCompra          PagoCompra[]
  pedidosTienda        PedidoTienda[]
  preferenciasTabla    PreferenciaTabla[]
  productos            Producto[]
  usuarios             Usuario[]
  whatsappEnvios       WhatsAppEnvio[]
  combos               Combo[]
  gruposModificadores  GrupoModificador[]

  @@index([providerToken])
  @@index([slugTienda])
}

model Usuario {
  id                     Int                     @id @default(autoincrement())
  nombre                 String
  dni                    String
  celular                String
  email                  String                  @unique
  password               String
  rol                    Rol
  empresaId              Int?
  estado                 EstadoType              @default(ACTIVO)
  telefono               String?
  permisos               String?
  compras                Compra[]
  comprobantes           Comprobante[]
  historialEstadosPedido HistorialEstadoPedido[]
  movimientosCaja        MovimientoCaja[]
  movimientosKardex      MovimientoKardex[]
  Notificacion           Notificacion[]
  pagos                  Pago[]
  pagosCompra            PagoCompra[]
  preferenciasTabla      PreferenciaTabla[]
  refreshTokens          RefreshToken[]
  empresa                Empresa?                @relation(fields: [empresaId], references: [id])
  whatsappEnvios         WhatsAppEnvio[]
}

model Categoria {
  id        Int        @id @default(autoincrement())
  nombre    String
  empresaId Int?
  empresa   Empresa?   @relation(fields: [empresaId], references: [id])
  productos Producto[]
}

model UnidadMedida {
  id        Int        @id @default(autoincrement())
  codigo    String     @unique
  nombre    String
  productos Producto[]
}

model Marca {
  id        Int        @id @default(autoincrement())
  nombre    String
  empresaId Int?
  empresa   Empresa?   @relation(fields: [empresaId], references: [id])
  productos Producto[]

  @@unique([empresaId, nombre])
}

model Producto {
  id                  Int                        @id @default(autoincrement())
  codigo              String
  descripcion         String
  categoriaId         Int?
  unidadMedidaId      Int
  tipoAfectacionIGV   String
  precioUnitario      Decimal
  valorUnitario       Decimal
  igvPorcentaje       Decimal                    @default(18.00)
  stock               Int
  estado              EstadoType                 @default(ACTIVO)
  creadoEn            DateTime                   @default(now())
  empresaId           Int?
  costoPromedio       Decimal?                   @default(0)
  stockMaximo         Int?
  stockMinimo         Int?                       @default(0)
  descripcionLarga    String?
  destacado           Boolean                    @default(false)
  imagenUrl           String?
  imagenesExtra       String?
  publicarEnTienda    Boolean                    @default(false)
  marcaId             Int?
  ratingAvg           Decimal?                   @default(0)
  ratingCount         Int?                       @default(0)
  codigoBarras        String?
  codigoDigemid       String?                    @unique
  concentracion       String?
  controlado          Boolean                    @default(false)
  factorConversion    Int                        @default(1)
  fechaFinOferta      DateTime?
  fechaInicioOferta   DateTime?
  laboratorio         String?
  ofertaActiva        Boolean                    @default(false)
  pesoGramos          Decimal?
  precioOferta        Decimal?
  presentacion        String?
  principioActivo     String?
  refrigerado         Boolean                    @default(false)
  requiereReceta      Boolean                    @default(false)
  unidadCompra        String?
  unidadVenta         String?
  volumenMl           Decimal?
  detalleCompras      DetalleCompra[]
  detalleComprobantes DetalleComprobante[]
  galeria             GaleriaProducto[]
  itemsPedido         ItemPedidoTienda[]
  movimientosKardex   MovimientoKardex[]
  categoria           Categoria?                 @relation(fields: [categoriaId], references: [id])
  empresa             Empresa?                   @relation(fields: [empresaId], references: [id])
  marca               Marca?                     @relation(fields: [marcaId], references: [id])
  unidadMedida        UnidadMedida               @relation(fields: [unidadMedidaId], references: [id])
  comboItems          ComboItem[]
  gruposModificadores ProductoGrupoModificador[]
  lotes               ProductoLote[]

  @@unique([empresaId, codigo])
  @@index([empresaId, publicarEnTienda])
  @@index([marcaId])
}

model TipoDocumento {
  id          Int       @id @default(autoincrement())
  codigo      String    @unique
  descripcion String
  clientes    Cliente[]
}

model Cliente {
  id              Int            @id @default(autoincrement())
  nombre          String
  nroDoc          String
  direccion       String?
  email           String?
  telefono        String?
  empresaId       Int?
  estado          EstadoType     @default(ACTIVO)
  tipoDocumentoId Int?
  departamento    String?
  distrito        String?
  provincia       String?
  ubigeo          String?
  persona         PersonaType    @default(CLIENTE)
  empresa         Empresa?       @relation(fields: [empresaId], references: [id])
  tipoDocumento   TipoDocumento? @relation(fields: [tipoDocumentoId], references: [id])
  compras         Compra[]
  comprobantes    Comprobante[]
}

model TipoOperacion {
  id           Int           @id @default(autoincrement())
  codigo       String        @unique
  descripcion  String
  comprobantes Comprobante[]
}

model MotivoNota {
  id           Int           @id @default(autoincrement())
  tipo         TipoNota
  codigo       String
  descripcion  String
  comprobantes Comprobante[] @relation("ComprobanteMotivo")

  @@unique([tipo, codigo])
}

model TipoDetraccion {
  id           Int           @id @default(autoincrement())
  codigo       String        @unique
  descripcion  String
  porcentaje   Decimal
  activo       Boolean       @default(true)
  comprobantes Comprobante[]
}

model MedioPagoDetraccion {
  id           Int           @id @default(autoincrement())
  codigo       String        @unique
  descripcion  String
  activo       Boolean       @default(true)
  comprobantes Comprobante[]
}

model Comprobante {
  id                    Int                  @id @default(autoincrement())
  ublVersion            String               @default("2.1")
  tipoDoc               String
  serie                 String
  correlativo           Int
  fechaEmision          DateTime
  formaPagoTipo         String
  formaPagoMoneda       String
  tipoMoneda            String
  observaciones         String?
  mtoOperGravadas       Float
  mtoIGV                Float
  valorVenta            Float
  totalImpuestos        Float
  subTotal              Float
  mtoImpVenta           Float
  estadoEnvioSunat      EstadoSunat          @default(PENDIENTE)
  medioPago             String?
  clienteId             Int
  empresaId             Int
  tipDocAfectado        String?
  numDocAfectado        String?
  creadoEn              DateTime             @default(now())
  tipoOperacionId       Int?
  motivoId              Int?
  mtoOperInafectas      Float                @default(0)
  mtoDescuentoGlobal    Float                @default(0)
  sunatCdrResponse      String?
  sunatCdrZip           String?
  sunatErrorMsg         String?
  sunatXml              String?
  documentoId           String?
  adelanto              Float?
  fechaRecojo           DateTime?
  saldo                 Float?               @default(0)
  estadoPago            EstadoPago?          @default(PENDIENTE_PAGO)
  descuentoOT           Float?               @default(0)
  descuentoPorcOT       Float?               @default(0)
  estadoOT              String?
  usuarioId             Int?
  s3CdrUrl              String?
  s3PdfUrl              String?
  s3XmlUrl              String?
  vuelto                Float?               @default(0)
  sunatLastRetryAt      DateTime?
  sunatNextRetryAt      DateTime?
  sunatRetriesCount     Int                  @default(0)
  cotizAdelanto         Float?               @default(0)
  cotizDescuento        Float?               @default(0)
  cotizFirmante         String?
  cotizIncluirImagenes  Boolean?             @default(false)
  cotizTerminos         String?
  cotizTipoPago         String?              @default("CONTADO")
  cotizVigencia         Int?                 @default(7)
  cuentaBancoNacion     String?
  medioPagoDetraccionId Int?
  montoDetraccion       Float?
  porcentajeDetraccion  Float?
  tipoDetraccionId      Int?
  cuotas                Json?
  cliente               Cliente              @relation(fields: [clienteId], references: [id])
  empresa               Empresa              @relation(fields: [empresaId], references: [id])
  medioPagoDetraccion   MedioPagoDetraccion? @relation(fields: [medioPagoDetraccionId], references: [id])
  motivo                MotivoNota?          @relation("ComprobanteMotivo", fields: [motivoId], references: [id])
  tipoDetraccion        TipoDetraccion?      @relation(fields: [tipoDetraccionId], references: [id])
  tipoOperacion         TipoOperacion?       @relation(fields: [tipoOperacionId], references: [id])
  usuario               Usuario?             @relation(fields: [usuarioId], references: [id])
  detalles              DetalleComprobante[]
  leyendas              Leyenda[]
  movimientosKardex     MovimientoKardex[]
  pagos                 Pago[]
  whatsappEnvios        WhatsAppEnvio[]
}

model DetalleComprobante {
  id                Int         @id @default(autoincrement())
  comprobanteId     Int
  productoId        Int?
  unidad            String
  descripcion       String
  cantidad          Float
  mtoValorUnitario  Float
  mtoValorVenta     Float
  mtoBaseIgv        Float
  porcentajeIgv     Float
  igv               Float
  tipAfeIgv         Int
  totalImpuestos    Float
  mtoPrecioUnitario Float
  comprobante       Comprobante @relation(fields: [comprobanteId], references: [id])
  producto          Producto?   @relation(fields: [productoId], references: [id])
}

model Leyenda {
  id            Int         @id @default(autoincrement())
  comprobanteId Int
  code          String
  value         String
  comprobante   Comprobante @relation(fields: [comprobanteId], references: [id])
}

model Pago {
  id            Int         @id @default(autoincrement())
  comprobanteId Int
  fecha         DateTime    @default(now())
  monto         Float
  medioPago     String
  observacion   String?
  referencia    String?
  creadoEn      DateTime    @default(now())
  empresaId     Int?
  usuarioId     Int?
  comprobante   Comprobante @relation(fields: [comprobanteId], references: [id], onDelete: Cascade)
  empresa       Empresa?    @relation(fields: [empresaId], references: [id])
  usuario       Usuario?    @relation(fields: [usuarioId], references: [id])

  @@index([comprobanteId])
  @@index([usuarioId])
  @@index([empresaId])
}

model MovimientoKardex {
  id               Int                   @id @default(autoincrement())
  productoId       Int
  empresaId        Int
  tipoMovimiento   TipoMovimiento
  concepto         String
  comprobanteId    Int?
  cantidad         Int
  stockAnterior    Int
  stockActual      Int
  costoUnitario    Decimal?
  valorTotal       Decimal?
  fecha            DateTime              @default(now())
  usuarioId        Int?
  observacion      String?
  lote             String?
  fechaVencimiento DateTime?
  compraId         Int?
  compra           Compra?               @relation(fields: [compraId], references: [id])
  comprobante      Comprobante?          @relation(fields: [comprobanteId], references: [id])
  empresa          Empresa               @relation(fields: [empresaId], references: [id])
  producto         Producto              @relation(fields: [productoId], references: [id])
  usuario          Usuario?              @relation(fields: [usuarioId], references: [id])
  movimientoLote   MovimientoKardexLote?

  @@index([productoId, fecha])
  @@index([empresaId, fecha])
  @@index([tipoMovimiento])
}

model RefreshToken {
  id        Int      @id @default(autoincrement())
  token     String   @unique
  usuarioId Int
  expiresAt DateTime
  createdAt DateTime @default(now())
  usuario   Usuario  @relation(fields: [usuarioId], references: [id])
}

model MovimientoCaja {
  id                 Int        @id @default(autoincrement())
  usuarioId          Int
  empresaId          Int
  tipoMovimiento     TipoCaja
  fecha              DateTime   @default(now())
  montoInicial       Decimal?
  montoFinal         Decimal?
  montoEfectivo      Decimal?   @default(0)
  montoYape          Decimal?   @default(0)
  montoPlin          Decimal?   @default(0)
  montoTransferencia Decimal?   @default(0)
  montoTarjeta       Decimal?   @default(0)
  observaciones      String?
  estado             EstadoType @default(ACTIVO)
  fechaCierre        DateTime?
  totalVentas        Decimal?   @default(0)
  totalIngresos      Decimal?   @default(0)
  diferencia         Decimal?   @default(0)
  turno              String?
  empresa            Empresa    @relation(fields: [empresaId], references: [id])
  usuario            Usuario    @relation(fields: [usuarioId], references: [id])

  @@index([usuarioId, fecha])
  @@index([empresaId, fecha])
  @@index([tipoMovimiento])
}

model PedidoTienda {
  id                Int                     @id @default(autoincrement())
  empresaId         Int
  clienteNombre     String
  clienteTelefono   String
  clienteEmail      String?
  clienteDireccion  String?
  clienteReferencia String?
  subtotal          Decimal
  igv               Decimal                 @default(0)
  total             Decimal
  estado            EstadoPedidoTienda      @default(PENDIENTE)
  medioPago         MedioPagoTienda         @default(YAPE)
  observaciones     String?
  referenciaTransf  String?
  creadoEn          DateTime                @default(now())
  actualizadoEn     DateTime                @updatedAt
  fechaConfirmacion DateTime?
  usuarioConfirma   Int?
  comprobanteId     Int?
  codigoSeguimiento String                  @unique
  costoEnvio        Decimal                 @default(0)
  notasInternas     String?
  tipoEntrega       TipoEntrega             @default(RECOJO)
  historialEstados  HistorialEstadoPedido[]
  items             ItemPedidoTienda[]
  empresa           Empresa                 @relation(fields: [empresaId], references: [id])

  @@index([empresaId, estado])
  @@index([creadoEn])
  @@index([codigoSeguimiento])
}

model ItemPedidoTienda {
  id            Int          @id @default(autoincrement())
  pedidoId      Int
  productoId    Int
  cantidad      Int
  precioUnit    Decimal
  subtotal      Decimal
  observacion   String?
  comboId       Int?
  comboSnapshot String?
  esCombo       Boolean      @default(false)
  combo         Combo?       @relation(fields: [comboId], references: [id])
  pedido        PedidoTienda @relation(fields: [pedidoId], references: [id], onDelete: Cascade)
  producto      Producto     @relation(fields: [productoId], references: [id])

  @@index([pedidoId])
  @@index([productoId])
  @@index([comboId])
}

model Combo {
  id                  Int                @id @default(autoincrement())
  empresaId           Int
  nombre              String
  descripcion         String?
  imagenUrl           String?
  precioRegular       Decimal
  precioCombo         Decimal
  descuentoPorcentaje Decimal?
  activo              Boolean            @default(true)
  stock               Int?
  fechaInicio         DateTime?
  fechaFin            DateTime?
  creadoEn            DateTime           @default(now())
  actualizadoEn       DateTime           @updatedAt
  pedidoItems         ItemPedidoTienda[]
  items               ComboItem[]
  empresa             Empresa            @relation(fields: [empresaId], references: [id], onDelete: Cascade)

  @@index([empresaId, activo])
  @@map("combos")
}

model ComboItem {
  id         Int      @id @default(autoincrement())
  comboId    Int
  productoId Int
  cantidad   Int      @default(1)
  combo      Combo    @relation(fields: [comboId], references: [id], onDelete: Cascade)
  producto   Producto @relation(fields: [productoId], references: [id], onDelete: Cascade)

  @@unique([comboId, productoId])
  @@map("combo_items")
}

model HistorialEstadoPedido {
  id             Int                 @id @default(autoincrement())
  pedidoId       Int
  estadoAnterior EstadoPedidoTienda?
  estadoNuevo    EstadoPedidoTienda
  usuarioId      Int?
  notas          String?
  creadoEn       DateTime            @default(now())
  pedido         PedidoTienda        @relation(fields: [pedidoId], references: [id], onDelete: Cascade)
  usuario        Usuario?            @relation(fields: [usuarioId], references: [id])

  @@index([pedidoId])
  @@index([creadoEn])
}

model Notificacion {
  id        Int      @id @default(autoincrement())
  usuarioId Int
  empresaId Int?
  tipo      String
  titulo    String
  mensaje   String
  leida     Boolean  @default(false)
  creadoEn  DateTime @default(now())
  empresa   Empresa? @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  usuario   Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  @@index([usuarioId, leida])
  @@index([empresaId])
}

model WhatsAppEnvio {
  id            Int            @id @default(autoincrement())
  comprobanteId Int
  empresaId     Int
  usuarioId     Int
  numeroDestino String
  estado        EstadoWhatsApp @default(PENDIENTE)
  mensajeId     String?
  error         String?
  costoUSD      Decimal        @default(0)
  incluyeXML    Boolean        @default(false)
  creadoEn      DateTime       @default(now())
  actualizadoEn DateTime       @updatedAt
  comprobante   Comprobante    @relation(fields: [comprobanteId], references: [id], onDelete: Cascade)
  empresa       Empresa        @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  usuario       Usuario        @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  @@index([comprobanteId])
  @@index([empresaId])
  @@index([estado])
  @@index([creadoEn])
}

model DisenoRubro {
  id               Int      @id @default(autoincrement())
  rubroId          Int      @unique
  colorPrimario    String   @default("#6A6CFF")
  colorSecundario  String   @default("#ffffff")
  colorAccento     String   @default("#FF6B6B")
  tipografia       String   @default("Inter")
  espaciado        String   @default("normal")
  bordeRadius      String   @default("medium")
  estiloBoton      String   @default("rounded")
  plantillaId      String   @default("moderna")
  creadoEn         DateTime @default(now())
  actualizadoEn    DateTime @updatedAt
  vistaProductos   String   @default("cards")
  tiempoEntregaMax Int?     @default(25)
  tiempoEntregaMin Int?     @default(15)
  rubro            Rubro    @relation(fields: [rubroId], references: [id], onDelete: Cascade)

  @@index([rubroId])
}

model Banner {
  id        Int      @id @default(autoincrement())
  empresaId Int
  titulo    String?
  subtitulo String?
  imagenUrl String
  linkUrl   String?
  orden     Int      @default(0)
  activo    Boolean  @default(true)
  creadoEn  DateTime @default(now())
  empresa   Empresa  @relation(fields: [empresaId], references: [id], onDelete: Cascade)

  @@index([empresaId, activo, orden])
}

model GaleriaProducto {
  id          Int      @id @default(autoincrement())
  productoId  Int
  imagenUrl   String
  orden       Int      @default(0)
  esPrincipal Boolean  @default(false)
  creadoEn    DateTime @default(now())
  producto    Producto @relation(fields: [productoId], references: [id], onDelete: Cascade)

  @@index([productoId])
  @@index([productoId, esPrincipal])
}

model PreferenciaTabla {
  id             Int      @id @default(autoincrement())
  usuarioId      Int
  empresaId      Int?
  tabla          String
  visibleColumns String
  creadoEn       DateTime @default(now())
  actualizadoEn  DateTime @updatedAt
  empresa        Empresa? @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  usuario        Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  @@unique([usuarioId, empresaId, tabla])
  @@index([usuarioId, empresaId, tabla])
}

model GrupoModificador {
  id            Int                        @id @default(autoincrement())
  empresaId     Int
  nombre        String
  descripcion   String?
  esObligatorio Boolean                    @default(false)
  seleccionMin  Int                        @default(0)
  seleccionMax  Int                        @default(1)
  orden         Int                        @default(0)
  activo        Boolean                    @default(true)
  creadoEn      DateTime                   @default(now())
  actualizadoEn DateTime                   @updatedAt
  empresa       Empresa                    @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  opciones      OpcionModificador[]
  productos     ProductoGrupoModificador[]

  @@index([empresaId, activo])
  @@map("grupos_modificadores")
}

model OpcionModificador {
  id            Int              @id @default(autoincrement())
  grupoId       Int
  nombre        String
  creadoEn      DateTime         @default(now())
  activo        Boolean          @default(true)
  actualizadoEn DateTime         @default(now()) @updatedAt
  descripcion   String?
  esDefault     Boolean          @default(false)
  orden         Int              @default(0)
  precioExtra   Decimal          @default(0)
  grupo         GrupoModificador @relation(fields: [grupoId], references: [id], onDelete: Cascade)

  @@index([grupoId])
  @@index([grupoId, activo])
  @@map("opciones_modificadores")
}

model ProductoGrupoModificador {
  id            Int              @id @default(autoincrement())
  productoId    Int
  grupoId       Int
  ordenOverride Int?
  grupo         GrupoModificador @relation(fields: [grupoId], references: [id], onDelete: Cascade)
  producto      Producto         @relation(fields: [productoId], references: [id], onDelete: Cascade)

  @@unique([productoId, grupoId])
  @@index([productoId])
  @@index([grupoId])
  @@map("producto_grupo_modificadores")
}

model ProductoPlantilla {
  id             Int      @id @default(autoincrement())
  nombre         String
  descripcion    String?
  imagenUrl      String?
  precioSugerido Decimal?
  rubroId        Int
  unidadConteo   String   @default("NIU")
  creadoEn       DateTime @default(now())
  actualizadoEn  DateTime @updatedAt
  categoria      String?
  codigo         String?  @unique
  marca          String?
  rubro          Rubro    @relation(fields: [rubroId], references: [id])

  @@index([rubroId])
  @@index([nombre])
  @@map("producto_plantillas")
}

model ProductoLote {
  id                Int                    @id @default(autoincrement())
  productoId        Int
  lote              String
  fechaVencimiento  DateTime
  fechaIngreso      DateTime               @default(now())
  stockActual       Int                    @default(0)
  stockInicial      Int                    @default(0)
  costoUnitario     Decimal?
  proveedor         String?
  activo            Boolean                @default(true)
  creadoEn          DateTime               @default(now())
  actualizadoEn     DateTime               @updatedAt
  movimientosKardex MovimientoKardexLote[]
  producto          Producto               @relation(fields: [productoId], references: [id], onDelete: Cascade)

  @@unique([productoId, lote])
  @@index([productoId, fechaVencimiento])
  @@index([productoId, activo])
  @@map("producto_lotes")
}

model MovimientoKardexLote {
  id             Int              @id @default(autoincrement())
  productoLoteId Int
  movimientoId   Int              @unique
  cantidad       Int
  stockAnterior  Int
  stockActual    Int
  movimiento     MovimientoKardex @relation(fields: [movimientoId], references: [id], onDelete: Cascade)
  lote           ProductoLote     @relation(fields: [productoLoteId], references: [id], onDelete: Cascade)

  @@index([productoLoteId])
  @@map("movimiento_kardex_lotes")
}

model Compra {
  id               Int                @id @default(autoincrement())
  empresaId        Int
  proveedorId      Int
  usuarioId        Int?
  tipoDoc          String             @default("FACTURA")
  serie            String
  numero           String
  fechaEmision     DateTime
  fechaVencimiento DateTime?
  moneda           String             @default("PEN")
  tipoCambio       Decimal?           @default(1)
  subtotal         Decimal            @default(0)
  igv              Decimal            @default(0)
  total            Decimal            @default(0)
  saldo            Decimal            @default(0)
  estado           EstadoCompra       @default(REGISTRADO)
  estadoPago       EstadoPago         @default(PENDIENTE_PAGO)
  observaciones    String?
  creadoEn         DateTime           @default(now())
  actualizadoEn    DateTime           @updatedAt
  cuotas           Json?
  empresa          Empresa            @relation(fields: [empresaId], references: [id])
  proveedor        Cliente            @relation(fields: [proveedorId], references: [id])
  usuario          Usuario?           @relation(fields: [usuarioId], references: [id])
  detalles         DetalleCompra[]
  movimientos      MovimientoKardex[]
  pagos            PagoCompra[]

  @@index([empresaId])
  @@index([proveedorId])
  @@index([fechaEmision])
}

model DetalleCompra {
  id               Int       @id @default(autoincrement())
  compraId         Int
  productoId       Int?
  descripcion      String
  cantidad         Decimal
  precioUnitario   Decimal
  subtotal         Decimal
  igv              Decimal
  total            Decimal
  lote             String?
  fechaVencimiento DateTime?
  compra           Compra    @relation(fields: [compraId], references: [id], onDelete: Cascade)
  producto         Producto? @relation(fields: [productoId], references: [id])

  @@index([compraId])
  @@index([productoId])
}

model PagoCompra {
  id         Int      @id @default(autoincrement())
  compraId   Int
  empresaId  Int
  usuarioId  Int?
  fecha      DateTime @default(now())
  monto      Decimal
  metodoPago String
  referencia String?
  creadoEn   DateTime @default(now())
  compra     Compra   @relation(fields: [compraId], references: [id], onDelete: Cascade)
  empresa    Empresa  @relation(fields: [empresaId], references: [id])
  usuario    Usuario? @relation(fields: [usuarioId], references: [id])

  @@index([compraId])
}

enum EstadoPedidoTienda {
  PENDIENTE
  CONFIRMADO
  EN_PREPARACION
  LISTO
  ENTREGADO
  CANCELADO
}

enum MedioPagoTienda {
  YAPE
  PLIN
  EFECTIVO
  TRANSFERENCIA
  TARJETA
}

enum TipoEntrega {
  RECOJO
  ENVIO
}

enum EstadoType {
  ACTIVO
  INACTIVO
  PLACEHOLDER
}

enum TipoNota {
  CREDITO
  DEBITO
}

enum Rol {
  ADMIN_SISTEMA
  ADMIN_EMPRESA
  USUARIO_EMPRESA
}

enum PersonaType {
  CLIENTE
  CLIENTE_PROVEEDOR
  PROVEEDOR
}

enum EstadoSunat {
  PENDIENTE
  ENVIADO
  EMITIDO
  RECHAZADO
  ANULADO
  REGISTRADO
  NO_APLICA
  FALLIDO_ENVIO
}

enum EstadoPago {
  PENDIENTE_PAGO
  COMPLETADO
  ANULADO
  PAGO_PARCIAL
}

enum TipoEmpresa {
  FORMAL
  INFORMAL
}

enum TipoMovimiento {
  INGRESO
  SALIDA
  AJUSTE
  TRANSFERENCIA
}

enum MetodoCosteo {
  FIFO
  LIFO
  PROMEDIO_PONDERADO
}

enum TipoCaja {
  APERTURA
  CIERRE
  INGRESO
  EGRESO
}

enum EstadoWhatsApp {
  PENDIENTE
  ENVIADO
  ENTREGADO
  LEIDO
  FALLIDO
}

enum EstadoCompra {
  REGISTRADO
  ANULADO
}
